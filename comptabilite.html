<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartLoc ‚Äì Comptabilit√© PDG</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#003366">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SmartLoc">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/609/609803.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <style>
    body {
      background-color: #f0f2f5;
      font-family: 'Segoe UI', sans-serif;
      padding-top: 120px;
    }
    .navbar {
      background-color: #003366;
      padding-top: 15px;
      padding-bottom: 15px;
    }
    .navbar-brand, .nav-link {
      color: white !important;
    }
    .nav-images {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-right: 15px;
    }
    .nav-logo, .nav-timbre {
      height: auto;
      max-height: 85px;
      width: auto;
      max-width: 25vw;
      object-fit: contain;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      padding: 2px;
    }
    h2 {
      color: #003366;
      font-weight: 700;
      letter-spacing: -1px;
    }
    .card-compta {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      background: white;
    }
    .configured {
      color: #198754 !important;
      font-weight: bold;
    }
    .pending {
      color: #dc3545 !important;
    }
    /* Style Modale */
    .modal-content {
      border-radius: 20px;
      border: none;
    }
    .modal-header {
      background-color: #003366;
      color: white;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }
    .btn-save {
      background-color: #003366;
      color: white;
      padding: 12px 30px;
      border-radius: 10px;
      transition: 0.3s;
    }
    .btn-save:hover {
      background-color: #00509e;
      color: white;
    }
    footer {
      margin-top: 40px;
      font-size: 0.9em;
      text-align: center;
      color: #666;
    }

    /* Style Impression identique aux pages pr√©c√©dentes */
    #printArea { display: none; }
    @media print {
        body > * { display: none !important; }
        #printArea {
            display: block !important;
            visibility: visible !important;
            position: absolute;
            left: 0; top: 0; width: 100%;
            padding: 20px;
            background: white;
        }
        .table { width: 100% !important; border-collapse: collapse !important; }
        .table-info { background-color: #d1ecf1 !important; -webkit-print-color-adjust: exact; }
        .table-success { background-color: #d4edda !important; -webkit-print-color-adjust: exact; }
        .table-warning { background-color: #fff3cd !important; -webkit-print-color-adjust: exact; }
        .print-header { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .print-footer { margin-top: 50px; text-align: right; font-weight: bold; }
        .sig-img { max-width: 150px; height: auto; display: block; margin-left: auto; margin-top: 10px; margin-bottom: 5px; }
    }

    @media (max-width: 576px) {
      body { padding-top: 100px; }
      .nav-logo, .nav-timbre { max-height: 50px; }
    }
  </style>
</head>
<body>

  <div id="printArea"></div>

  <div id="mainContent">
    <nav class="navbar fixed-top navbar-expand-lg">
      <div class="container-fluid">
        <div class="nav-images">
          <img src="logo.png" alt="Logo" class="nav-logo">
          <img src="timbre.png" alt="Timbre" class="nav-timbre">
        </div>
        <a class="navbar-brand fw-bold fs-3" href="#">SmartLoc</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon bg-light"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Tableau de bord</a></li>
            <li class="nav-item"><a class="nav-link" href="config.html">Configuration</a></li>
            <li class="nav-item"><a class="nav-link" href="gestion.html">Gestion</a></li>
            <li class="nav-item"><a class="nav-link active" href="comptabilite.html">Comptabilit√©</a></li>
            <li class="nav-item"><a class="nav-link" href="parametres.html">Param√®tres</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card-compta p-4 text-center mb-4">
            <h2 class="mb-4">üìà Param√©trage des Gains PDG</h2>
            <p class="text-muted mb-4">S√©lectionnez un bien immobilier pour d√©finir le pourcentage de commission de gestion.</p>
            
            <div class="mb-4 text-start">
              <label class="form-label fw-bold">üè¢ Tous les biens immobiliers</label>
              <select id="selectBien" class="form-select form-select-lg" onchange="verifierSelection()">
                <option value="" selected disabled>Choisir un appartement...</option>
              </select>
            </div>

            <button id="btnOuvrirModale" class="btn btn-primary btn-lg w-100 py-3 d-none" onclick="ouvrirModale()">
              Configurer les gains pour ce bien
            </button>
          </div>

          <div class="card-compta p-4 mb-4">
            <h4 class="text-primary fw-bold mb-3">üìä R√©capitulatif Comptable</h4>
            
            <div class="row g-3 mb-3">
              <div class="col-12">
                <label class="form-label fw-bold">üîç Consulter les biens configur√©s</label>
                <select id="selectBienConfigure" class="form-select" onchange="afficherDetailsComptables()">
                  <option value="" selected disabled>S√©lectionner un bien configur√©...</option>
                </select>
              </div>
              <div class="col-md-5">
                <label class="form-label small fw-bold">üìÖ Du (D√©but)</label>
                <input type="date" id="filtreDebut" class="form-control form-control-sm" onchange="afficherDetailsComptables()">
              </div>
              <div class="col-md-5">
                <label class="form-label small fw-bold">üìÖ Au (Fin)</label>
                <input type="date" id="filtreFin" class="form-control form-control-sm" onchange="afficherDetailsComptables()">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="reinitialiserFiltres()">Tout</button>
              </div>
            </div>

            <div id="zoneDetailsComptables" class="d-none">
              <div class="table-responsive" id="recapTableContainer">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>D√©tail</th>
                      <th class="text-end">Valeur</th>
                    </tr>
                  </thead>
                  <tbody id="corpsDetailsComptables">
                    </tbody>
                </table>
              </div>

              <div class="mt-4 p-3 border rounded bg-light">
                  <h6 class="fw-bold mb-3">üí∏ Enregistrer un retrait de commission</h6>
                  <div class="row g-2">
                      <div class="col-md-8">
                          <input type="number" id="montantRetrait" class="form-control" placeholder="Montant √† retirer (FCFA)">
                      </div>
                      <div class="col-md-4">
                          <button class="btn btn-danger w-100" onclick="enregistrerRetrait()">Retirer</button>
                      </div>
                  </div>
              </div>

              <button class="btn btn-success w-100 mt-3" onclick="imprimerRecapitulatif()">üñ®Ô∏è Imprimer ce rapport</button>
            </div>
          </div>

        </div>
      </div>

      <footer>
        Con√ßu par <strong>Plateny AMOUSSOU</strong> ‚Äì Professeur & Innovateur local<br />
        üìß atizoun@gmail.com | üìû 01 97 74 40 35
      </footer>
    </div>
  </div>

  <div class="modal fade" id="modalCompta" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title">üíé Configuration du Gain PDG</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <form id="formCompta">
            <div class="mb-3">
              <label class="form-label fw-bold">Nom du Bien</label>
              <input type="text" id="modalNomBien" class="form-control bg-light" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Pourcentage de gain (%)</label>
              <div class="input-group">
                <span class="input-group-text bg-white">üìä</span>
                <input type="number" id="pourcentageGain" class="form-control" placeholder="Ex: 10" required min="0" max="100">
                <span class="input-group-text bg-white">%</span>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Date d'effet</label>
              <div class="input-group">
                <span class="input-group-text bg-white">üìÖ</span>
                <input type="date" id="dateEffet" class="form-control" required>
              </div>
            </div>
            <div id="msgSucces" class="alert alert-success d-none mt-3">
              ‚úÖ Configuration enregistr√©e avec succ√®s !
            </div>
            <div class="mt-4">
              <button type="submit" class="btn btn-save w-100">Valider la configuration</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const selectBien = document.getElementById('selectBien');
    const selectBienConfigure = document.getElementById('selectBienConfigure');
    const btnOuvrirModale = document.getElementById('btnOuvrirModale');
    const modalCompta = new bootstrap.Modal(document.getElementById('modalCompta'));
    const formCompta = document.getElementById('formCompta');
    const zoneDetails = document.getElementById('zoneDetailsComptables');
    const corpsDetails = document.getElementById('corpsDetailsComptables');
    const filtreDebut = document.getElementById('filtreDebut');
    const filtreFin = document.getElementById('filtreFin');
    const printArea = document.getElementById('printArea');

    function chargerBiens() {
      const appartements = JSON.parse(localStorage.getItem('appartements')) || [];
      const comptaConfig = JSON.parse(localStorage.getItem('compta_config')) || {};
      
      selectBien.innerHTML = '<option value="" selected disabled>Choisir un appartement...</option>';
      selectBienConfigure.innerHTML = '<option value="" selected disabled>S√©lectionner un bien configur√©...</option>';
      
      appartements.forEach((apt, index) => {
        const isConfigured = comptaConfig[index] !== undefined;
        const option = document.createElement('option');
        option.value = index;
        
        if (isConfigured) {
          option.textContent = `${apt.nom} ‚Äì ${apt.locataire} (CONFIGUR√â ‚úÖ)`;
          option.classList.add('configured');
          
          const optionConf = document.createElement('option');
          optionConf.value = index;
          optionConf.textContent = `${apt.nom} (${apt.locataire})`;
          selectBienConfigure.appendChild(optionConf);
        } else {
          option.textContent = `${apt.nom} ‚Äì ${apt.locataire} (√Ä FAIRE ‚è≥)`;
          option.classList.add('pending');
        }
        selectBien.appendChild(option);
      });
    }

    function verifierSelection() {
      if (selectBien.value !== "") {
        btnOuvrirModale.classList.remove('d-none');
      }
    }

    function reinitialiserFiltres() {
      filtreDebut.value = "";
      filtreFin.value = "";
      afficherDetailsComptables();
    }

    function afficherDetailsComptables() {
      const index = selectBienConfigure.value;
      if (index === "") return;

      const appartements = JSON.parse(localStorage.getItem('appartements')) || [];
      const comptaConfig = JSON.parse(localStorage.getItem('compta_config')) || {};
      const paiementsGlobal = JSON.parse(localStorage.getItem('paiements')) || {};
      const retraitsGlobal = JSON.parse(localStorage.getItem('retraits_commission')) || {};
      
      const apt = appartements[index];
      const config = comptaConfig[index];
      const paiementsApt = paiementsGlobal[index] || [];
      const retraitsApt = retraitsGlobal[index] || [];

      const debut = filtreDebut.value;
      const fin = filtreFin.value;

      const filtrerParDate = (item) => {
        const dateStr = item.dateEnregistrement ? item.dateEnregistrement.split('T')[0] : (item.date || "");
        if (!dateStr) return true;
        if (debut && dateStr < debut) return false;
        if (fin && dateStr > fin) return false;
        return true;
      };

      const paiementsFiltr√©s = paiementsApt.filter(p => p.type === 'Paiement' && filtrerParDate(p));
      const retraitsFiltr√©s = retraitsApt.filter(r => filtrerParDate(r));

      const totalEncaisse = paiementsFiltr√©s.reduce((sum, p) => sum + parseFloat(p.montant), 0);
      const montantGainPDGTotal = (totalEncaisse * (parseFloat(config.pourcentage) / 100));
      const totalRetraits = retraitsFiltr√©s.reduce((sum, r) => sum + parseFloat(r.montant), 0);
      const soldeRestant = montantGainPDGTotal - totalRetraits;

      const periodeTexte = (debut || fin) ? 
        `P√©riode : Du ${debut || 'd√©but'} au ${fin || 'aujourd\'hui'}` : 
        "P√©riode : Historique complet";

      corpsDetails.innerHTML = `
        <tr><td><strong>Bien / Locataire</strong></td><td class="text-end">${apt.nom} / ${apt.locataire}</td></tr>
        <tr><td><strong>Loyer Mensuel</strong></td><td class="text-end">${apt.cout.toLocaleString()} FCFA</td></tr>
        <tr><td><strong>% Gain PDG</strong></td><td class="text-end fw-bold text-primary">${config.pourcentage} %</td></tr>
        <tr><td><strong>Filtre Appliqu√©</strong></td><td class="text-end small text-muted">${periodeTexte}</td></tr>
        <tr class="table-info">
          <td><strong>Total Encaiss√©</strong></td>
          <td class="text-end fw-bold">${totalEncaisse.toLocaleString()} FCFA</td>
        </tr>
        <tr class="table-success">
          <td><strong>Commission G√©n√©r√©e</strong></td>
          <td class="text-end fw-bold">${montantGainPDGTotal.toLocaleString()} FCFA</td>
        </tr>
        <tr class="table-warning text-danger">
          <td><strong>Total Retraits</strong></td>
          <td class="text-end fw-bold">-${totalRetraits.toLocaleString()} FCFA</td>
        </tr>
        <tr style="background-color: #003366; color: white;">
          <td><strong>SOLDE RESTANT</strong></td>
          <td class="text-end fw-bold" style="font-size: 1.2rem;">${soldeRestant.toLocaleString()} FCFA</td>
        </tr>
      `;

      zoneDetails.classList.remove('d-none');
    }

    function enregistrerRetrait() {
        const index = selectBienConfigure.value;
        const montant = parseFloat(document.getElementById('montantRetrait').value);
        
        if (isNaN(montant) || montant <= 0) {
            alert("Veuillez saisir un montant de retrait valide.");
            return;
        }

        if (!confirm(`Confirmez-vous le retrait de ${montant.toLocaleString()} FCFA sur cette commission ?`)) return;

        const retraitsGlobal = JSON.parse(localStorage.getItem('retraits_commission')) || {};
        if (!retraitsGlobal[index]) retraitsGlobal[index] = [];

        retraitsGlobal[index].push({
            montant: montant,
            date: new Date().toISOString().split('T')[0]
        });

        localStorage.setItem('retraits_commission', JSON.stringify(retraitsGlobal));
        document.getElementById('montantRetrait').value = '';
        alert("Retrait enregistr√© !");
        afficherDetailsComptables();
    }

    function imprimerRecapitulatif() {
        const params = JSON.parse(localStorage.getItem('smartloc_params')) || {};
        const pdgNom = params.pdgNom || "Le PDG";
        const pdgSig = params.pdgSig || "";

        const recapHTML = document.getElementById('recapTableContainer').innerHTML;
        const entete = `
            <div class="text-center mb-4">
                <div class="print-header">
                    <img src="logo.png" style="max-height:80px;">
                    <img src="timbre.png" style="max-height:80px;">
                </div>
                <h3 style="color:#003366; margin-top:10px;">RAPPORT DE COMMISSION ET SOLDE PDG</h3>
                <hr>
                <p>Date d'√©dition : ${new Date().toLocaleDateString()}</p>
            </div>
        `;

        const signatureHTML = pdgSig ? `<img src="${pdgSig}" class="sig-img" alt="Signature PDG">` : `<div style="height:60px;"></div>`;

        const footer = `
            <div class="print-footer">
                <p>Le PDG</p>
                ${signatureHTML}
                <p style="margin-top:0;">${pdgNom}</p>
                <div style="border-bottom: 1px solid #000; width: 200px; margin-left: auto; margin-top:5px;"></div>
            </div>
        `;
        
        printArea.innerHTML = entete + recapHTML + footer;
        setTimeout(() => { 
            window.print(); 
            setTimeout(() => { printArea.innerHTML = ''; }, 1000); 
        }, 500);
    }

    function ouvrirModale() {
      const index = selectBien.value;
      const appartements = JSON.parse(localStorage.getItem('appartements')) || [];
      const comptaConfig = JSON.parse(localStorage.getItem('compta_config')) || {};
      document.getElementById('modalNomBien').value = appartements[index].nom;
      if (comptaConfig[index]) {
        document.getElementById('pourcentageGain').value = comptaConfig[index].pourcentage;
        document.getElementById('dateEffet').value = comptaConfig[index].date;
      } else {
        document.getElementById('pourcentageGain').value = '';
        document.getElementById('dateEffet').value = new Date().toISOString().split('T')[0];
      }
      document.getElementById('msgSucces').classList.add('d-none');
      modalCompta.show();
    }

    formCompta.addEventListener('submit', function(e) {
      e.preventDefault();
      const index = selectBien.value;
      const pourcentage = document.getElementById('pourcentageGain').value;
      const date = document.getElementById('dateEffet').value;
      const comptaConfig = JSON.parse(localStorage.getItem('compta_config')) || {};
      comptaConfig[index] = { pourcentage: pourcentage, date: date };
      localStorage.setItem('compta_config', JSON.stringify(comptaConfig));
      const msg = document.getElementById('msgSucces');
      msg.classList.remove('d-none');
      setTimeout(() => {
        modalCompta.hide();
        chargerBiens();
        btnOuvrirModale.classList.add('d-none');
        if(selectBienConfigure.value === index) afficherDetailsComptables();
      }, 1500);
    });

    window.onload = chargerBiens;
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW enregistr√© !', reg))
          .catch(err => console.log('√âchec SW', err));
      });
    }
  </script>
</body>
</html>
